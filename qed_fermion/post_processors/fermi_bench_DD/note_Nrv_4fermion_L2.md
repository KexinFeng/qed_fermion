# Nrv for 4 fermion

## Orthogonality
### n_samples = Nrv = 200 for both

#### one delta
Max absolute difference from orthogonality (atol): 0.058090440928936005

#### two delta
Mismatched elements: 741363 / 1679616 (44.1%)
Greatest absolute difference: 0.06733332574367523 at index (11, 22, 0, 0) (up to 0.01 allowed)
Greatest relative difference: inf at index (0, 0, 0, 1) (up to 0.01 allowed)
external_prod.real[..., 0, 0]:
 tensor([[ 1.0000e+00, -7.6667e-03,  2.3333e-03,  ...,  1.6667e-03,
         -6.6667e-04, -1.1333e-02],
        [-7.6667e-03,  1.0000e+00,  1.0000e-02,  ..., -1.2000e-02,
          9.6667e-03, -1.3000e-02],
        [ 2.3333e-03,  1.0000e-02,  1.0000e+00,  ...,  4.0000e-03,
          0.0000e+00, -1.0333e-02],
        ...,
        [ 1.6667e-03, -1.2000e-02,  4.0000e-03,  ...,  1.0000e+00,
         -9.6667e-03,  1.2333e-02],
        [-6.6667e-04,  9.6667e-03,  0.0000e+00,  ..., -9.6667e-03,
          1.0000e+00, -7.3333e-03],
        [-1.1333e-02, -1.3000e-02, -1.0333e-02,  ...,  1.2333e-02,
         -7.3333e-03,  1.0000e+00]], device='cuda:0')
external_prod.imag[..., 0, 0]:
 tensor([[ 5.2674e-12,  1.1667e-02, -3.4333e-02,  ...,  1.1000e-02,
          1.0000e-02, -2.0000e-03],
        [-1.1667e-02,  5.2674e-12, -3.2000e-02,  ...,  6.6667e-03,
         -3.9667e-02,  9.6667e-03],
        [ 3.4333e-02,  3.2000e-02,  5.2674e-12,  ...,  9.3333e-03,
          0.0000e+00, -1.6667e-03],
        ...,
        [-1.1000e-02, -6.6667e-03, -9.3333e-03,  ...,  5.2674e-12,
         -1.3667e-02, -3.5667e-02],
        [-1.0000e-02,  3.9667e-02,  0.0000e+00,  ...,  1.3667e-02,
          5.2674e-12,  1.2000e-02],
        [ 2.0000e-03, -9.6667e-03,  1.6667e-03,  ...,  3.5667e-02,
         -1.2000e-02,  5.2674e-12]], device='cuda:0')
external_prod shape: torch.Size([36, 36, 36, 36])
Max absolute difference from two-identity orthogonality (atol): 0.06733332574367523

### Nrv = 100
Inner product shape: torch.Size([36, 36])
external_product.real[0, :10]:
 tensor([ 1.0000,  0.0070, -0.0230,  0.0280, -0.0200,  0.0070, -0.0140, -0.0110,
         0.0260,  0.0600], device='cuda:0')
external_product.real[1, :10]:
 tensor([ 7.0000e-03,  1.0000e+00,  1.6000e-02,  2.3000e-02,  1.7000e-02,
        -4.0000e-03,  3.0000e-03,  2.8610e-09,  1.3000e-02,  1.9000e-02],
       device='cuda:0')
external_product.real[-1, -10:]:
 tensor([-5.7000e-02,  1.0000e-02, -7.0000e-03, -4.9000e-02,  4.0000e-03,
         1.6000e-02,  2.8000e-02,  1.4305e-09, -2.4000e-02,  1.0000e+00],
       device='cuda:0')
Max absolute difference from orthogonality (atol): 0.07951100170612335
Error info: Tensor-likes are not close!

Mismatched elements: 750964 / 1679616 (44.7%)
Greatest absolute difference: 0.101666659116745 at index (3, 15, 0, 0) (up to 0.01 allowed)
Greatest relative difference: inf at index (0, 0, 0, 1) (up to 0.01 allowed)
external_prod.real[..., 0, 0]:
 tensor([[ 1.0000,  0.0100, -0.0860,  ...,  0.0347, -0.0037, -0.0043],
        [ 0.0100,  1.0000, -0.0193,  ...,  0.0067,  0.0137, -0.0437],
        [-0.0860, -0.0193,  1.0000,  ...,  0.0113, -0.0137,  0.0223],
        ...,
        [ 0.0347,  0.0067,  0.0113,  ...,  1.0000,  0.0163,  0.0190],
        [-0.0037,  0.0137, -0.0137,  ...,  0.0163,  1.0000, -0.0087],
        [-0.0043, -0.0437,  0.0223,  ...,  0.0190, -0.0087,  1.0000]],
       device='cuda:0')
external_prod.imag[..., 0, 0]:
 tensor([[-6.6415e-12,  9.3333e-03, -7.0667e-02,  ...,  6.0000e-03,
          3.2333e-02, -1.1000e-02],
        [-9.3333e-03, -6.6415e-12, -2.8667e-02,  ..., -2.6667e-03,
         -4.1000e-02, -2.3000e-02],
        [ 7.0667e-02,  2.8667e-02, -6.6415e-12,  ..., -4.6000e-02,
         -4.8333e-02,  9.6667e-03],
        ...,
        [-6.0000e-03,  2.6667e-03,  4.6000e-02,  ..., -6.6415e-12,
         -5.9000e-02, -5.7000e-02],
        [-3.2333e-02,  4.1000e-02,  4.8333e-02,  ...,  5.9000e-02,
         -6.6415e-12,  8.0000e-03],
        [ 1.1000e-02,  2.3000e-02, -9.6667e-03,  ...,  5.7000e-02,
         -8.0000e-03, -6.6415e-12]], device='cuda:0')
external_prod shape: torch.Size([36, 36, 36, 36])
Max absolute difference from two-identity orthogonality (atol): 0.101666659116745



## L2 term N choose 4 with Gt_gt computed from se

### Nrv = 200
num_samples_L2_nchoose4: 64,684,950
batch_size_L2_nchoose4: 200,000
```
relative_distance_r: 0.2774434983730316, 
relative_distance_k: 0.2520579397678375
obsr_gt['DD_k']:
 tensor([[[0.0056, 0.0039, 0.0015, 0.0009, 0.0015, 0.0039],
         [0.0051, 0.0039, 0.0018, 0.0011, 0.0015, 0.0037],
         [0.0049, 0.0038, 0.0021, 0.0015, 0.0019, 0.0037],
         [0.0048, 0.0034, 0.0021, 0.0019, 0.0021, 0.0034],
         [0.0049, 0.0037, 0.0019, 0.0015, 0.0021, 0.0038],
         [0.0051, 0.0037, 0.0015, 0.0011, 0.0018, 0.0039]]], device='cuda:0')
obsr_se['DD_k']:
 tensor([[[0.0038, 0.0019, 0.0018, 0.0009, 0.0026, 0.0032],
         [0.0038, 0.0030, 0.0017, 0.0015, 0.0018, 0.0043],
         [0.0045, 0.0032, 0.0015, 0.0013, 0.0022, 0.0042],
         [0.0041, 0.0033, 0.0021, 0.0017, 0.0017, 0.0034],
         [0.0040, 0.0024, 0.0017, 0.0013, 0.0020, 0.0031],
         [0.0036, 0.0020, 0.0016, 0.0015, 0.0027, 0.0042]]], device='cuda:0')
**********
obsr_gt['DD_r']:
 tensor([[[ 2.9199e-03, -9.3700e-04,  1.3887e-04,  3.3527e-06,  1.3887e-04,
          -9.3700e-04],
         [ 2.6830e-05,  7.9541e-05, -6.3003e-06, -1.5253e-05,  7.5861e-06,
           1.4577e-04],
         [-5.8722e-06,  5.4834e-06,  2.7080e-05, -1.7525e-05,  2.4756e-05,
          -5.0670e-06],
         [-2.2442e-05,  1.9398e-05,  1.0835e-05,  1.2589e-06,  1.0835e-05,
           1.9398e-05],
         [-5.8722e-06, -5.0670e-06,  2.4756e-05, -1.7525e-05,  2.7080e-05,
           5.4834e-06],
         [ 2.6830e-05,  1.4577e-04,  7.5861e-06, -1.5253e-05, -6.3003e-06,
           7.9541e-05]]], device='cuda:0')
obsr_se['DD_r']:
 tensor([[[ 2.5979e-03, -9.8232e-04,  2.6911e-05, -2.3640e-05,  4.7321e-05,
          -2.8750e-04],
         [ 6.4816e-05,  8.2287e-05, -1.4759e-05, -8.6716e-06,  1.7080e-05,
          -6.8751e-05],
         [-1.1916e-04,  6.3970e-05, -3.3843e-05, -6.3396e-05,  1.8875e-05,
          -3.0408e-05],
         [ 6.2748e-05,  1.3477e-04, -3.8740e-05,  1.1797e-04,  9.1249e-06,
          -8.3483e-05],
         [ 5.6787e-05, -2.5145e-05, -1.2707e-05, -6.8737e-05,  4.4054e-05,
           8.4873e-05],
         [ 3.3535e-05,  3.2239e-05,  4.6926e-05,  1.1669e-04,  7.7378e-05,
          -2.0051e-04]]], device='cuda:0')
point value DD_M:
DD_M_gt: 0.004789752420037985, 
DD_M_se: 0.0040939729660749435
Norm of obsr_gt['DD_k']: 0.019333327189087868
Norm of obsr_se['DD_k']: 0.016787251457571983
---
Norm of obsr_gt['DD_r']: 0.003222221042960882
Norm of obsr_se['DD_r']: 0.002822705777361989
```


### Nrv = 100

num_samples_L2_nchoose4: 3,921,225
batch_size_L2_nchoose4: 100,000
---------------------------------
relative_distance_r: 0.5073302388191223, 
relative_distance_k: 0.48696309328079224
obsr_gt['DD_k']:
 tensor([[[ 1.1145e-02,  6.5672e-03, -3.7828e-04, -3.0273e-03, -3.7828e-04,
           6.5672e-03],
         [ 9.6887e-03,  5.7087e-03, -8.7385e-04, -3.1589e-03, -8.0708e-04,
           6.3003e-03],
         [ 9.1862e-03,  5.7958e-03,  6.2338e-06, -2.0175e-03,  2.9240e-04,
           6.1553e-03],
         [ 9.2488e-03,  5.5219e-03,  1.9797e-04, -1.3409e-03,  1.9797e-04,
           5.5219e-03],
         [ 9.1862e-03,  6.1553e-03,  2.9240e-04, -2.0175e-03,  6.2340e-06,
           5.7958e-03],
         [ 9.6887e-03,  6.3003e-03, -8.0708e-04, -3.1589e-03, -8.7385e-04,
           5.7087e-03]]], device='cuda:0')
obsr_se['DD_k']:
 tensor([[[ 9.1314e-03,  2.7095e-03, -9.7305e-04, -1.7556e-03, -1.7974e-03,
           4.9363e-03],
         [ 6.9901e-03,  4.6429e-04, -2.4999e-03, -4.6151e-03,  5.8421e-04,
           5.0718e-03],
         [ 4.8503e-03,  3.7557e-03, -9.9643e-05, -2.1400e-03,  1.6466e-04,
           6.1190e-03],
         [ 3.7374e-03,  4.1266e-03,  6.3616e-03, -1.8748e-03, -1.1498e-03,
           6.1045e-03],
         [ 5.0611e-03,  1.7296e-03, -6.8638e-04, -9.4647e-04, -2.1694e-03,
           3.4131e-03],
         [ 5.9668e-03,  3.2062e-03, -2.6319e-04, -1.1144e-03,  1.5053e-03,
           6.3562e-03]]], device='cuda:0')
**********
obsr_gt['DD_r']:
 tensor([[[ 3.1221e-03, -3.0688e-03,  2.4822e-04,  6.5535e-05,  2.4822e-04,
          -3.0688e-03],
         [ 3.9239e-05,  2.7286e-04, -2.6662e-05, -1.5056e-06,  2.3187e-05,
           1.6419e-04],
         [ 9.9080e-05, -9.1046e-06,  6.6234e-05, -4.2065e-05,  2.8616e-05,
          -8.0542e-06],
         [-1.7414e-04, -3.3689e-06,  2.5085e-05,  3.1294e-05,  2.5085e-05,
          -3.3688e-06],
         [ 9.9080e-05, -8.0542e-06,  2.8616e-05, -4.2065e-05,  6.6234e-05,
          -9.1046e-06],
         [ 3.9239e-05,  1.6419e-04,  2.3187e-05, -1.5056e-06, -2.6662e-05,
           2.7286e-04]]], device='cuda:0')
obsr_se['DD_r']:
 tensor([[[ 1.9517e-03, -2.9048e-03,  1.5518e-04,  2.3114e-05, -1.6597e-04,
          -1.1336e-03],
         [ 3.2114e-04,  6.5858e-04, -2.1059e-04, -1.6881e-04, -3.6174e-04,
           3.1460e-04],
         [ 4.6833e-04,  2.7904e-04, -9.8214e-05,  3.3722e-04,  1.5111e-04,
           1.1211e-04],
         [ 2.1264e-04,  1.0084e-04, -5.0416e-04, -2.1797e-04, -1.3438e-04,
           8.2648e-05],
         [ 4.3040e-05, -9.6569e-05, -2.7284e-04, -4.4897e-04,  7.7273e-05,
          -2.9233e-04],
         [-1.1257e-04,  4.1414e-05, -2.5732e-04,  3.7660e-04, -3.3132e-04,
           1.3079e-04]]], device='cuda:0')
point value DD_M:
DD_M_gt: 0.00924881361424923, 
DD_M_se: 0.003737419843673706
Norm of obsr_gt['DD_k']: 0.03230253607034683
Norm of obsr_se['DD_k']: 0.023547623306512833
---
Norm of obsr_gt['DD_r']: 0.005383756477385759
Norm of obsr_se['DD_r']: 0.0039986856281757355


## L2 term N choose 4 with true Gt_gt


### Nrv = 200
num_samples_L2_nchoose4: 64684950
batch_size_L2_nchoose4: 400000
---------------------------------
relative_distance_r: 0.4580370783805847, 
relative_distance_k: 0.43346256017684937
obsr_gt['DD_k']:
 tensor([[[0.0025, 0.0025, 0.0026, 0.0026, 0.0026, 0.0025],
         [0.0025, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025],
         [0.0025, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025],
         [0.0024, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025],
         [0.0025, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025],
         [0.0025, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025]]], device='cuda:0')
obsr_se['DD_k']:
 tensor([[[0.0038, 0.0019, 0.0018, 0.0009, 0.0026, 0.0032],
         [0.0039, 0.0030, 0.0017, 0.0015, 0.0018, 0.0043],
         [0.0045, 0.0033, 0.0015, 0.0013, 0.0022, 0.0043],
         [0.0041, 0.0033, 0.0021, 0.0017, 0.0017, 0.0034],
         [0.0040, 0.0024, 0.0017, 0.0013, 0.0020, 0.0031],
         [0.0036, 0.0020, 0.0016, 0.0015, 0.0027, 0.0042]]], device='cuda:0')
**********
obsr_gt['DD_r']:
 tensor([[[2.5541e-03, 4.8162e-05, 1.1904e-05, 1.4483e-08, 1.1904e-05,
          4.8162e-05],
         [5.6104e-08, 8.9566e-06, 6.1682e-10, 3.8790e-08, 6.4361e-10,
          8.9850e-06],
         [9.0134e-08, 3.4449e-10, 6.6302e-10, 5.3620e-12, 6.4690e-10,
          3.0153e-10],
         [1.3622e-11, 1.1536e-09, 3.4561e-13, 1.5516e-11, 3.4561e-13,
          1.1536e-09],
         [9.0134e-08, 3.0153e-10, 6.4690e-10, 5.3620e-12, 6.6302e-10,
          3.4449e-10],
         [5.6104e-08, 8.9850e-06, 6.4361e-10, 3.8790e-08, 6.1682e-10,
          8.9566e-06]]], device='cuda:0')
obsr_se['DD_r']:
 tensor([[[ 2.6142e-03, -9.8962e-04,  2.5779e-05, -2.3844e-05,  4.4703e-05,
          -2.9002e-04],
         [ 6.6736e-05,  8.1998e-05, -1.8511e-05, -7.4275e-06,  1.6803e-05,
          -7.1839e-05],
         [-1.2061e-04,  6.5649e-05, -3.4885e-05, -6.1894e-05,  2.2473e-05,
          -3.3868e-05],
         [ 6.1675e-05,  1.3331e-04, -4.0031e-05,  1.2013e-04,  8.0144e-06,
          -8.1360e-05],
         [ 5.6584e-05, -2.3216e-05, -1.6803e-05, -6.8409e-05,  4.4727e-05,
           8.3195e-05],
         [ 3.4807e-05,  3.4344e-05,  4.7088e-05,  1.1817e-04,  7.9182e-05,
          -2.0118e-04]]], device='cuda:0')
point value DD_M:
DD_M_gt: 0.002445933409035206, 
DD_M_se: 0.004107829183340073
Norm of obsr_gt['DD_k']: 0.015330933965742588
Norm of obsr_se['DD_k']: 0.016893532127141953
---
Norm of obsr_gt['DD_r']: 0.002555155660957098
Norm of obsr_se['DD_r']: 0.002840875182300806

# Assert the vectors are close using torch.testing
torch.testing.assert_close(
    obsr_gt['DD_r'], obsr_se['DD_r'],
    atol=6e-2, rtol=0
)
torch.testing.assert_close(
    obsr_gt['DD_k'], obsr_se['DD_k'],
    atol=6e-2, rtol=0
)
PASS


### Nrv = 100

num_samples_L2_nchoose4: 3921225
batch_size_L2_nchoose4: 200000
---------------------------------
relative_distance_r: 1.4416263103485107, 
relative_distance_k: 1.4089140892028809
obsr_gt['DD_k']:
 tensor([[[0.0025, 0.0025, 0.0026, 0.0026, 0.0026, 0.0025],
         [0.0025, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025],
         [0.0025, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025],
         [0.0024, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025],
         [0.0025, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025],
         [0.0025, 0.0025, 0.0026, 0.0027, 0.0026, 0.0025]]], device='cuda:0')
obsr_se['DD_k']:
 tensor([[[ 9.3228e-03,  2.6536e-03, -1.0172e-03, -1.6703e-03, -1.4320e-03,
           4.6173e-03],
         [ 7.5351e-03, -1.8309e-05, -2.2668e-03, -4.5056e-03,  3.1802e-04,
           5.3871e-03],
         [ 5.2539e-03,  3.9356e-03, -1.3731e-04, -2.5229e-03, -2.1289e-04,
           6.2316e-03],
         [ 3.8629e-03,  4.3611e-03,  6.5555e-03, -2.0103e-03, -9.0698e-04,
           6.3739e-03],
         [ 4.5957e-03,  2.2068e-03, -7.8627e-04, -1.3048e-03, -2.1622e-03,
           3.3483e-03],
         [ 6.3420e-03,  2.3796e-03, -5.1140e-04, -1.2356e-03,  1.2953e-03,
           6.2767e-03]]], device='cuda:0')
**********
obsr_gt['DD_r']:
 tensor([[[2.5541e-03, 4.8162e-05, 1.1904e-05, 1.4483e-08, 1.1904e-05,
          4.8162e-05],
         [5.6104e-08, 8.9566e-06, 6.1682e-10, 3.8790e-08, 6.4361e-10,
          8.9850e-06],
         [9.0134e-08, 3.4449e-10, 6.6302e-10, 5.3620e-12, 6.4690e-10,
          3.0153e-10],
         [1.3622e-11, 1.1536e-09, 3.4561e-13, 1.5516e-11, 3.4561e-13,
          1.1536e-09],
         [9.0134e-08, 3.0153e-10, 6.4690e-10, 5.3620e-12, 6.6302e-10,
          3.4449e-10],
         [5.6104e-08, 8.9850e-06, 6.4361e-10, 3.8790e-08, 6.1682e-10,
          8.9566e-06]]], device='cuda:0')
obsr_se['DD_r']:
 tensor([[[ 1.9487e-03, -2.9968e-03,  6.5948e-05, -3.1792e-05, -4.2704e-05,
          -1.1515e-03],
         [ 3.8627e-04,  6.5178e-04, -2.5422e-04, -1.3179e-04, -3.8260e-04,
           2.2623e-04],
         [ 5.4170e-04,  2.7554e-04, -1.0371e-04,  2.7626e-04,  9.1573e-05,
           1.5029e-04],
         [ 2.3090e-04,  1.0539e-04, -4.5337e-04, -2.5793e-04, -8.4699e-05,
           8.4117e-05],
         [ 6.8828e-05, -1.0559e-04, -2.3116e-04, -4.1611e-04,  3.7129e-05,
          -2.1680e-04],
         [-1.3702e-04,  1.0119e-04, -2.8908e-04,  4.3026e-04, -4.6618e-04,
           7.0744e-05]]], device='cuda:0')
point value DD_M:
DD_M_gt: 0.002445933409035206, 
DD_M_se: 0.003862854326143861
Norm of obsr_gt['DD_k']: 0.015330933965742588
Norm of obsr_se['DD_k']: 0.024004049599170685
---
Norm of obsr_gt['DD_r']: 0.002555155660957098
Norm of obsr_se['DD_r']: 0.004076051525771618


# Assert the vectors are close using torch.testing
torch.testing.assert_close(
    obsr_gt['DD_r'], obsr_se['DD_r'],
    atol=6e-2, rtol=0
)
torch.testing.assert_close(
    obsr_gt['DD_k'], obsr_se['DD_k'],
    atol=6e-2, rtol=0
)
PASS
